name: Deploy and Forget

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Target environment
        required: true
        type: choice
        options:
          - production

jobs:
  deploy:
    runs-on: self-hosted
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build New Image
        run: docker build -t symfony-app:latest ./backend

      - name: Preparation & Cleanup
        run: |
          docker rm -f symfony-new 2>/dev/null || true

      - name: Start New Container (Stage)
        run: |
          docker run -d \
            --name symfony-new \
            -p 8081:80 \
            -e APP_ENV=prod \
            symfony-app:latest

          sleep 5

      - name: Database Migration (Pre-Swap)
        run: |
          docker exec symfony-new php bin/console doctrine:migrations:migrate --no-interaction

      - name: User-Centric Health Check
        run: |
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:8081)

          if [ "$STATUS" -ne 200 ]; then
            docker rm -f symfony-new
            exit 1
          fi

      - name: The Great Swap
        run: |
          docker rm -f live-app 2>/dev/null || true

          docker stop
