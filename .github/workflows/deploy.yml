name: Deploy and Forget

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Target environment
        required: true
        type: choice
        options:
          - production

jobs:
  deploy:
    runs-on: self-hosted
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build New Image
        run: docker build --target=frankenphp_prod -t symfony-app:latest ./backend

      - name: Preparation & Cleanup
        run: |
          docker rm -f symfony-new 2>/dev/null || true

      - name: Start Staging Container
        run: |
          docker run -d \
            --network app-network \
            --name symfony-new \
            -v /srv/symfony-prod/.env.prod:/app/.env.prod:ro \
            -e APP_ENV=prod \
            symfony-app:latest

      - name: Wait for PHP + DB
        run: |
          # Wait until Symfony can connect to the DB
          for i in {1..20}; do
            docker exec symfony-new php bin/console about >/dev/null 2>&1 && break
            echo "Waiting for container to be ready..."
            sleep 3
          done

      - name: Post-Deployment Setup (Staging)
        run: |
          docker exec symfony-new php bin/console cache:clear --env=prod
          docker exec symfony-new php bin/console cache:warmup --env=prod
          docker exec symfony-new php bin/console doctrine:migrations:migrate --no-interaction

      - name: User-Centric Health Check
        run: |
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:8081)
          if [ "$STATUS" -ne 200 ]; then
            echo "Staging container unhealthy, dumping logs:"
            docker logs symfony-new
            docker rm -f symfony-new
            exit 1
          fi

      - name: Swap Staging â†’ Production
        run: |
          # Remove old production container if exists
          docker rm -f live-app 2>/dev/null || true

          # Stop staging so we can rename it
          docker stop symfony-new
          docker rename symfony-new live-app

          # Start the renamed container on port 80
          docker start live-app
