name: Deploy and Forget

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build New Image
        run: docker build -t symfony-app:latest .

      - name: Preparation & Cleanup
        run: |
          # Remove any leftover 'staged' container from a failed previous run
          docker rm -f symfony-new 2>/dev/null || true

      - name: Start New Container (Stage)
        run: |
          # Start on temporary port 8081
          docker run -d \
            --name symfony-new \
            -p 8081:80 \
            -e APP_ENV=prod \
            symfony-app:latest
          
          # Wait for PHP-FPM to initialize
          sleep 5

      - name: Database Migration (Pre-Swap)
        run: |
          # Run migrations against the NEW container before it goes live
          docker exec symfony-new php bin/console doctrine:migrations:migrate --no-interaction

      - name: User-Centric Health Check
        run: |
          # Ping the new container
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:8081)
          
          if [ "$STATUS" -eq 200 ]; then
            echo "New version is healthy (200 OK)."
          else
            echo "New version returned $STATUS. Killing staging container."
            docker rm -f symfony-new
            exit 1
          fi

      - name: The Great Swap
        run: |
          # 1. Kill the old production container if it exists
          docker rm -f live-app 2>/dev/null || true
          
          # 2. Stop the staged container so we can rename/rebind it
          docker stop symfony-new
          
          # 3. Rename it to the production name
          docker rename symfony-new live-app
          
          # 4. Start it on the primary production port (80)
          # Note: We use 'docker run' logic here if you want to change ports, 
          # but since we already created it, we'll commit and re-run or 
          # simply use a Proxy like Nginx to handle the port swap.
          
          # EASIEST SWAP: Stop the new one and start it again on Port 80
          docker rm -f live-app
          docker run -d \
            --name live-app \
            -p 80:80 \
            --restart always \
            -e APP_ENV=prod \
            symfony-app:latest